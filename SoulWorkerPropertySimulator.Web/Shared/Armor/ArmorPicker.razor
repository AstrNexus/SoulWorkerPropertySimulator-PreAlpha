@using SoulWorkerPropertySimulator.Extensions
@using SoulWorkerPropertySimulator.Models
@using SoulWorkerPropertySimulator.Services
@using SoulWorkerPropertySimulator.Web.Shared.Effects
@using SoulWorkerPropertySimulator.Web.Shared.Plugin
@inject IDataProvideService Data
@inject IArmorComputeService ArmorCompute

@if (Options.Any())
{
    <div class="card">
        <div class="card-header d-flex">
            <select class="form-select" @bind="Selected">
                <option></option>
                @foreach (var item in Options)
                {
                    <option value="@item.GetHashCode()">@item.FullName</option>
                }
            </select>
            @if (SelectedBlueprint != null)
            {
                <div class="step">
                    <div>強化 +</div>
                    <select class="form-select" disabled="@(SelectedBlueprint == null || SelectedBlueprint.ValidStep.Count <= 1)" @bind="SelectedStep">
                        @if (SelectedBlueprint == null || !SelectedBlueprint.ValidStep.Any())
                        {
                            <option value="0">0</option>
                        }
                        else
                        {
                            @foreach (var i in SelectedBlueprint.ValidStep)
                            {
                                <option value="@i">@i</option>
                            }
                        }
                    </select>
                </div>
            }
        </div>
        <div>
            <div>品質</div>
            <div>
                <input type="number" min="0" max="100" @bind="SelectedQuality" disabled="@(SelectedBlueprint == null)"/>
            </div>
        </div>
        <div>

        </div>

        @if (SelectedBlueprint != null)
        {
            <EffectsCreator @ref="_effectsCreator" NotifyUpdate="Update" Blueprint="SelectedBlueprint" DefaultEffects="DefaultArmor?.SelectedEffect"/>

            @if (SelectedBlueprint!.PluginLimit > 0)
            {
                <PluginsCreator @ref="_pluginsCreator"
                                 NotifyUpdate="Update"
                                 Field="SelectedBlueprint!.Field == ArmorField.Weapon ? PluginField.Weapon : PluginField.Gear"
                                 Limit="SelectedBlueprint.PluginLimit"
                                 Level="SelectedBlueprint.Level"
                                 DefaultPlugins="DefaultArmor?.Plugins"/>
            }

            <div>
                <select @bind="SelectedTagHash">
                    <option>無</option>
                    @foreach (var tag in TagOptions)
                    {
                        <option value="@tag.GetHashCode()">@tag.Name</option>
                    }
                </select>
            </div>
            <div>
                @if (SelectedTag != null)
                {
                    <select @bind="SelectedTagRare">
                        @if (SelectedTag != null)
                        {
                            @foreach (var rare in SelectedTag.ValidRare)
                            {
                                <option value="@rare">@rare.GetDescription()</option>
                            }
                        }
                    </select>
                }
            </div>
        }
    </div >
}

@code
{
    [Parameter]
    public ArmorField Field { get; set; }

    [Parameter]
    public Armor? DefaultArmor { get; set; }

    private IReadOnlyCollection<ArmorBlueprint> Options { get; set; } = null!;

    private IReadOnlyCollection<Tag> TagOptions { get; set; } = null!;

    private int? _selected;

    public ArmorBlueprint? SelectedBlueprint
    {
        set => Selected = value?.GetHashCode();
        get => Options.FirstOrDefault(x => x.GetHashCode() == _selected);
    }

    private int? Selected
    {
        get => _selected;
        set
        {
            if (_selected == value) { return; }
            _selected = value;
            _selectedQuality = 1;
            _selectedStep = SelectedBlueprint?.ValidStep.Max() ?? 0;
            Update();
        }
    }

    private decimal _selectedQuality;

    public int SelectedQuality
    {
        get => (int) (_selectedQuality * 100);
        set
        {
            _selectedQuality = value / 100m;
            if (_notInitializePhase) { Update(); }
        }
    }

    private int _selectedStep;

    public int SelectedStep
    {
        get => _selectedStep;
        set
        {
            _selectedStep = value;
            if (_notInitializePhase) { Update(); }
        }
    }

    private int? _selectedTag;

    private Tag? SelectedTag
    {
        set => _selectedTag = value?.GetHashCode();
        get => _selectedTag == null ? null : TagOptions.FirstOrDefault(x => x.GetHashCode() == _selectedTag);
    }

    private int? SelectedTagHash
    {
        get => _selectedTag;
        set
        {
            if (_selectedTag == value) { return; }
            _selectedTag = value;
            SelectedTagRare = SelectedTag?.ValidRare.Max();
        }
    }

    private TagRare? _selectedTagRare;

    private TagRare? SelectedTagRare
    {
        get => _selectedTagRare;
        set
        {
            _selectedTagRare = value;
            Update();
        }
    }

    public Tag? Tag
    {
        get
        {
            var tag = SelectedTag;
            if (tag == null || SelectedTagRare == null) { return null; }
            return tag with { Rare = SelectedTagRare.Value };
        }
    }

    private EffectsCreator? _effectsCreator;
    private PluginsCreator? _pluginsCreator;

    private Armor? Item
    {
        get
        {
            try
            {
                if (_effectsCreator == null) { return null; }

                var item = SelectedBlueprint?.Create(_selectedQuality, _effectsCreator.Effects);
                if (item == null) { return null; }
                return item with
                {
                    Plugins = _pluginsCreator?.Plugins ?? Array.Empty<Plugin>(),
                    Tag = Tag,
                    Step = SelectedStep
                    };
            }
            catch (InvalidOperationException) {
                return null;
            }
        }
    }

    private void Update()
    {
        var item = Item;
        if (item == null) { ArmorCompute.Clear(Field); }
        else
        { ArmorCompute.Change(item); }
    }

    private bool _notInitializePhase;

    protected override void OnAfterRender(bool firstRender)
    {
        base.OnAfterRender(firstRender);
        if (firstRender) { _notInitializePhase = true; }
    }

    protected override void OnInitialized()
    {
        base.OnInitializedAsync();

        Options = Data.GetArmorBlueprints(Field).ToList();
        TagOptions = Data.GetTags(Field == ArmorField.Weapon ? TagField.Weapon : TagField.Gear);

        if (DefaultArmor != null)
        {
            _selected = DefaultArmor.Blueprint.GetHashCode();
            _selectedQuality = DefaultArmor.SelectedRatio;
            _selectedStep = DefaultArmor.Step;
            _selectedTag = DefaultArmor.Tag == null ? null : (DefaultArmor.Tag with { Rare = TagRare.Heroic }).GetHashCode();
            _selectedTagRare = DefaultArmor.Tag?.Rare;
        }
    }
}